import streamlit as st

st.set_page_config(page_title="Step 3 - ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒãƒªãƒ¥ãƒ¼è¨ˆç®—", layout="centered")
st.markdown("<h3 style='white-space: nowrap;'>ğŸŒ± Step 3ï¼šã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒãƒªãƒ¥ãƒ¼ã®è¨ˆç®—</h3>", unsafe_allow_html=True)


with st.expander("â“ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ç›®çš„"):
    st.markdown("""
    - æ˜ç¤ºçš„ãª5å¹´é–“ã®äºˆæ¸¬ã®ã‚ã¨ã€ä¼æ¥­ãŒ**æ°¸ç¶šçš„ã«æˆé•·ã—ã¦ã„ãéƒ¨åˆ†**ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã«**ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒãƒªãƒ¥ãƒ¼ï¼ˆTVï¼‰**ã‚’ä½¿ã„ã¾ã™ã€‚
    - TVã¯ã€DCFã«ãŠã„ã¦ã—ã°ã—ã°ä¼æ¥­ä¾¡å€¤ã®å¤§éƒ¨åˆ†ã‚’å ã‚ã¾ã™ã€‚
    - ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€**æ°¸ä¹…æˆé•·ç‡ï¼ˆgï¼‰**ã‚’è¨­å®šã—ã€5å¹´ç›®ã®FCFã¨WACCã‹ã‚‰TVã‚’è¨ˆç®—ã—ã¾ã™ã€‚
    - è¨ˆç®—å¼ï¼š  
      **TV = FCF Ã— (1 + g) / (WACC - g)**  
    - æ³¨æ„ï¼šgã¯WACCæœªæº€ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

    ### ğŸ’¡ gï¼ˆæ°¸ä¹…æˆé•·ç‡ï¼‰ã®æ¨å®šã«ã¤ã„ã¦
    - æ°¸ä¹…æˆé•·ç‡ g ã¨ã¯ã€ä¼æ¥­ãŒ6å¹´ç›®ä»¥é™ã«ã©ã‚Œãã‚‰ã„ã®ãƒšãƒ¼ã‚¹ã§æˆé•·ã—ã¦ã„ãã‹ã‚’è¦‹ç©ã‚‚ã‚‹å€¤ã§ã™ã€‚
    - å®Ÿå‹™ã§ã¯ã€**ä¼æ¥­ã®å£²ä¸Šæ§‹æˆã¨å„åœ°åŸŸã®çµŒæ¸ˆæˆé•·ç‡ï¼ˆåç›®GDPï¼‰**ã‹ã‚‰ g ã‚’æ¨å®šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    - ãŸã¨ãˆã°ï¼š
      - æ—¥æœ¬ï¼š1%ï¼ˆæˆç†Ÿå¸‚å ´ï¼‰
      - ç±³å›½ï¼š3%ï¼ˆå®‰å®šæˆé•·ï¼‰
      - æ–°èˆˆå›½ï¼š5%ï¼ˆé«˜æˆé•·ï¼‰
    - åœ°åŸŸåˆ¥å£²ä¸Šæ§‹æˆæ¯”ã‚’ä½¿ãˆã°ã€**å®Ÿæ…‹ã«å³ã—ãŸæˆé•·ç‡ g** ã‚’è‡ªå‹•ã§æ¨å®šã§ãã¾ã™ã€‚
    - ãªãŠã€ç›´æ¥å…¥åŠ›ã—ãŸã„æ–¹ã¯ã€Œæ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚

    ğŸ”œ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒãƒªãƒ¥ãƒ¼ã‚’ç®—å‡ºã—ãŸã‚‰ã€æ¬¡ã¯ã„ã‚ˆã„ã‚ˆ **Step 4ï¼šä¼æ¥­ä¾¡å€¤ã¨ç†è«–æ ªä¾¡ã®ç®—å‡º** ã«é€²ã¿ã¾ã™ã€‚
    """)

st.subheader("âœ… æ°¸ä¹…æˆé•·ç‡ï¼ˆgï¼‰ã®è¨­å®šæ–¹æ³•ã‚’é¸æŠ")
mode = st.radio("é¸æŠè‚¢ï¼š", ["åœ°åŸŸåˆ¥å£²ä¸Šæ¯”ç‡ã‹ã‚‰æ¨å®šã™ã‚‹", "æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹"])

g = 0.0
if mode == "åœ°åŸŸåˆ¥å£²ä¸Šæ¯”ç‡ã‹ã‚‰æ¨å®šã™ã‚‹":
    st.write("ğŸŒ åœ°åŸŸåˆ¥å£²ä¸Šæ§‹æˆæ¯”ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å…¥åŠ›ï¼ˆåˆè¨ˆ100%ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰")
    col1, col2, col3 = st.columns(3)
    with col1:
        jp = st.slider("æ—¥æœ¬", 0.0, 1.0, 0.6, 0.01)
    with col2:
        us = st.slider("ç±³å›½", 0.0, 1.0, 0.3, 0.01)
    with col3:
        em = st.slider("æ–°èˆˆå›½", 0.0, 1.0, 0.1, 0.01)

    total = jp + us + em
    if abs(total - 1.0) > 0.01:
        st.error("âš ï¸ åœ°åŸŸæ¯”ç‡ã®åˆè¨ˆãŒ100%ï¼ˆ=1.0ï¼‰ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚èª¿æ•´ã—ã¦ãã ã•ã„ã€‚")
    else:
        g = jp * 0.01 + us * 0.03 + em * 0.05
        st.success(f"ğŸ“ˆ æ¨å®šã•ã‚ŒãŸæ°¸ä¹…æˆé•·ç‡ gï¼š{g:.2%}")
else:
    g = st.number_input("æ°¸ä¹…æˆé•·ç‡ï¼ˆgï¼‰ã‚’ç›´æ¥å…¥åŠ›ï¼ˆä¾‹ï¼š0.015 = 1.5%ï¼‰", value=0.015, format="%.3f")

st.markdown("---")
st.subheader("ğŸ“Œ ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒãƒªãƒ¥ãƒ¼ã®è¨ˆç®—")

# å¿…è¦ãªå€¤ã‚’session_stateã‹ã‚‰å–å¾—
future_fcfs = st.session_state.get("future_fcfs", [])
wacc = st.session_state.get("wacc", None)

if not future_fcfs or wacc is None:
    st.warning("âš ï¸ Step 1ã¨Step 2ã®å…¥åŠ›ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚")
else:
    fcf_last = future_fcfs[-1]
    if g >= wacc:
        st.error("âŒ gï¼ˆæ°¸ä¹…æˆé•·ç‡ï¼‰ã¯WACCã‚ˆã‚Šå°ã•ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚èª¿æ•´ã—ã¦ãã ã•ã„ã€‚")
    else:
        terminal_value = fcf_last * (1 + g) / (wacc - g)
        st.success(f"ğŸ’° ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒãƒªãƒ¥ãƒ¼ï¼ˆTVï¼‰ï¼ {terminal_value:,.0f} ç™¾ä¸‡å††")
        st.session_state["terminal_value"] = terminal_value
        st.session_state["g"] = g
